# ssmd-data-ts: TypeScript data server for market data
FROM denoland/deno:bin-2.6.10 AS deno_bin
FROM debian:bookworm-slim

RUN apt-get update && apt-get install -y --no-install-recommends curl ca-certificates && rm -rf /var/lib/apt/lists/*
RUN groupadd -g 1000 deno && useradd -u 1000 -g deno -m deno

COPY --from=deno_bin /deno /usr/local/bin/deno

WORKDIR /app

# Copy only necessary files for the server
COPY deno.json ./
COPY src/server/ ./src/server/
COPY src/lib/ ./src/lib/
COPY src/cli/ ./src/cli/

# Cache dependencies (server only; CLI deps cached at runtime for CronJob use)
RUN deno cache src/server/main.ts

# Create non-root user for security
USER deno

# Expose port
EXPOSE 8080

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
  CMD curl -f http://localhost:8080/health || exit 1

# Run the server (--allow-ffi for DuckDB N-API, --allow-write=/tmp for DuckDB temp files)
CMD ["deno", "run", "--allow-net", "--allow-env", "--allow-read", "--allow-sys", "--allow-ffi", "--allow-write=/tmp", "src/server/main.ts"]
