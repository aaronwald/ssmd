# ssmd-lifecycle-consumer container
FROM denoland/deno:2.6.5

# Create non-root user
RUN useradd -r -s /bin/false ssmd

WORKDIR /app

# Copy source
COPY deno.json .
COPY src ./src

# Cache dependencies
RUN deno cache src/cli/commands/lifecycle-consumer.ts

# Fix ownership for non-root user
RUN chown -R ssmd:ssmd /app /deno-dir

# Switch to non-root user
USER ssmd

# Default env vars (can be overridden)
ENV NATS_URL=nats://nats.nats.svc.cluster.local:4222
ENV NATS_STREAM=PROD_KALSHI
ENV NATS_FILTER=prod.kalshi.lifecycle.>
ENV CONSUMER_NAME=lifecycle-consumer

CMD ["run", "--allow-net", "--allow-env", "src/cli/commands/lifecycle-consumer.ts"]
