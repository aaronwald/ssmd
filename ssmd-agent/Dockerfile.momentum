# ssmd-momentum container
FROM denoland/deno:2.6.8

# Create non-root user
RUN useradd -r -s /bin/false ssmd

WORKDIR /app

# Copy source
COPY deno.json .
COPY src ./src

# Cache dependencies
RUN deno cache src/cli/main.ts

# Fix ownership for non-root user
RUN chown -R ssmd:ssmd /app /deno-dir

# Switch to non-root user
USER ssmd

# Default env vars (can be overridden)
ENV NATS_URL=nats://nats.nats.svc.cluster.local:4222

CMD ["run", "--allow-net", "--allow-env", "--allow-read", "src/cli/main.ts", "momentum", "run", "--config", "/config/momentum.yaml"]
