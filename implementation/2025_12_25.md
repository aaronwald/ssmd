# Implementation Notes: 2025-12-25

## Session Overview

- **Date**: December 25, 2025
- **Primary Objectives**: Fix hanging unit tests for NatsWriter, complete NATS publishing implementation
- **Overall Outcome**: Success - all tests pass, CI builds succeed, container v0.1.4 published

## What Was Accomplished

### Test Fixes
- [x] Fixed NatsWriter tests that were hanging indefinitely
- [x] Root cause: InMemoryTransport doesn't support wildcard subscriptions
- [x] Solution: Changed test subscriptions from wildcards to exact subjects:
  - `dev.kalshi.trade.>` → `dev.kalshi.trade.KXTEST-123`
  - `dev.kalshi.ticker.>` → `dev.kalshi.ticker.KXTEST-456`

### Build & Deployment
- [x] All 98 Rust tests passing
- [x] CI pipeline: lint, test, docker all green
- [x] Container image pushed: `ghcr.io/aaronwald/ssmd-connector:0.1.4`
- [x] Tagged release: v0.1.4

## Key Decisions Made

### Test Design
- **Decision**: Subscribe to exact NATS subjects in unit tests
- **Rationale**: InMemoryTransport creates separate broadcast channels per exact subject string. Wildcard pattern matching (e.g., `dev.kalshi.trade.>`) is a NATS server feature, not something the mock transport implements.
- **Trade-off**: Tests are less realistic but reliably pass. Integration tests (marked `#[ignore]`) against real NATS validate wildcard behavior.

## Files Created or Modified

### Rust Source
| File | Change |
|------|--------|
| `ssmd-rust/crates/connector/src/nats_writer.rs` | Fixed test subscriptions: wildcard → exact subject |

## Commands Executed

```bash
# Fix tests and verify
make rust-test

# Build and verify
make rust-build

# Commit and push
git add -A
git commit -m "feat: add NATS publishing with configurable writer selection"
git push origin main

# Tag and push for container build
git tag -a v0.1.4 -m "feat: add NATS publishing with configurable writer"
git push origin v0.1.4

# Watch CI
gh run watch 20496124094 --exit-status
```

## Issues Encountered and Resolved

### Issue: NatsWriter tests hanging
- **Symptom**: `make rust-test` hung indefinitely
- **Root Cause**: Test subscribed to `dev.kalshi.trade.>` (wildcard), but publish went to `dev.kalshi.trade.KXTEST-123` (exact). InMemoryTransport stores subscriptions by exact string, so they never matched.
- **Fix**: Changed test subscriptions to exact subjects that match publish targets

### Code Fix
```rust
// Before (hangs forever)
let mut sub = transport.subscribe("dev.kalshi.trade.>").await.unwrap();

// After (works correctly)
let mut sub = transport.subscribe("dev.kalshi.trade.KXTEST-123").await.unwrap();
```

## Lessons Learned

### What Worked Well
- Quick diagnosis of the hanging test issue by understanding InMemoryTransport's exact-match behavior
- CI/CD pipeline caught issues early and validated fixes

### What Could Be Improved
- Consider adding wildcard matching support to InMemoryTransport for more realistic testing
- Or add a comment in InMemoryTransport documenting this limitation

## Next Steps

### Immediate Priorities
1. Deploy v0.1.4 to Kubernetes with NATS transport configuration
2. Verify trades and tickers flowing to NATS JetStream
3. Set up `nats sub` monitoring to confirm data flow

### Outstanding Tasks from TODO.md
- [ ] Add raw JSON passthrough to NATS alongside Cap'n Proto
- [ ] Publish L2 orderbook updates to NATS
- [ ] Phase 3: Agent Pipeline MVP

### Deployment Configuration
For NATS streaming (production use case):
```yaml
# environments/prod-nats.yaml
transport:
  transport_type: nats
  url: nats://nats.nats.svc.cluster.local:4222
```

For file capture (archival use case):
```yaml
# environments/prod-file.yaml
transport:
  transport_type: memory
storage:
  path: /data
```

---

## Session 2: ssmd-agent Container

### Session Overview
- **Time**: Evening session
- **Primary Objectives**: Create LangGraph agent stub container with CI/CD
- **Overall Outcome**: Success - Deno container built, CI green, v0.1.5 published

### What Was Accomplished

#### Agent Container Setup
- [x] Created `ssmd-agent/` directory structure
- [x] Dockerfile using `denoland/deno:2.1.4` base image
- [x] Health check stub at `/health` and `/healthz` endpoints
- [x] Non-root user (`ssmd`) for security
- [x] Local Docker build tested and verified

#### CI/CD Pipeline
- [x] Updated `.github/workflows/ci.yaml` with agent job (deno check + docker build)
- [x] Created `.github/workflows/build-agent.yaml` for tag-triggered publishing
- [x] Both workflows completed successfully
- [x] Container published: `ghcr.io/aaronwald/ssmd-agent:0.1.5`

#### Documentation
- [x] Design doc: `docs/plans/2025-12-25-agent-container-stub.md`
- [x] Updated `DEPLOYMENT.md` with agent deployment manifests
- [x] Added network policies for future NATS/Anthropic egress

### Key Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Runtime | Deno | Native TypeScript, matches agent-pipeline design |
| Directory | `ssmd-agent/` | Top-level, consistent with `ssmd-rust/` |
| Stub scope | Health check only | Minimal proof of concept, add features incrementally |
| Image name | `ssmd-agent` | Generic, matches `ssmd-connector` pattern |
| Dockerfile | Single-stage | Simple app doesn't need multi-stage complexity |

### Files Created or Modified

| File | Change |
|------|--------|
| `ssmd-agent/Dockerfile` | Deno container with health check |
| `ssmd-agent/deno.json` | Tasks and compiler options |
| `ssmd-agent/src/main.ts` | Health check HTTP server |
| `.github/workflows/ci.yaml` | Added agent job |
| `.github/workflows/build-agent.yaml` | New workflow for container publishing |
| `docs/plans/2025-12-25-agent-container-stub.md` | Design document |
| `DEPLOYMENT.md` | Added agent deployment section |

### Commands Executed

```bash
# Create directory structure
mkdir -p /workspaces/ssmd/ssmd-agent/src

# Build and test locally
docker build -t ssmd-agent:test ./ssmd-agent
docker run -d --name ssmd-agent-test -p 8081:8080 ssmd-agent:test
curl -s http://localhost:8081/health  # {"status":"ok"}
curl -s http://localhost:8081/        # {"service":"ssmd-agent","version":"0.1.0"}

# Commit and push
git add ssmd-agent/ .github/workflows/ docs/plans/2025-12-25-agent-container-stub.md
git commit -m "feat: add ssmd-agent Deno container with CI"
git push origin main

# Tag and push for container build
git tag -a v0.1.5 -m "feat: add ssmd-agent Deno container"
git push origin v0.1.5

# Update docs
git add DEPLOYMENT.md
git commit -m "docs: add ssmd-agent deployment guide"
git push origin main
```

### Issues Encountered and Resolved

#### Issue 1: Deno cache location
- **Symptom**: Multi-stage build failed copying `/root/.cache/deno`
- **Root Cause**: Deno official image uses `/deno-dir` not `/root/.cache/deno`
- **Fix**: Simplified to single-stage build (cache not needed for stub)

#### Issue 2: Permission denied on startup
- **Symptom**: Container exited with "Permission denied (os error 13)"
- **Root Cause**: Files owned by root, but running as `ssmd` user
- **Fix**: Added `RUN chown -R ssmd:ssmd /app /deno-dir`

#### Issue 3: Environment variable access
- **Symptom**: "Requires env access to PORT" error
- **Root Cause**: Deno needs explicit `--allow-env` permission
- **Fix**: Added `--allow-env` to CMD in Dockerfile

### CI/CD Results

| Workflow | Status | Duration |
|----------|--------|----------|
| Build ssmd-agent | success | 34s |
| Build ssmd-connector | success | 4m51s |
| CI | success | 3m43s |

### Lessons Learned

#### What Worked Well
- Brainstorming skill helped structure the design discussion
- Single-stage Dockerfile keeps things simple for a stub
- Deno builds much faster than Rust (34s vs 5min)

#### What Could Be Improved
- Should have checked Deno permission model upfront
- Could add a `.dockerignore` for cleaner builds

### Next Steps

#### Immediate Priorities
1. Add NATS client to ssmd-agent
2. Implement LangGraph.js integration
3. Add signal loading from filesystem

#### Agent Pipeline Tasks (from TODO.md)
- [ ] LangGraph.js dependencies setup
- [ ] PostgreSQL checkpointer
- [ ] State Builders (orderbook, priceHistory)
- [ ] Signal interface and evaluator

### Container Images Published

| Image | Tag | Size |
|-------|-----|------|
| `ghcr.io/aaronwald/ssmd-connector` | 0.1.5 | ~80MB |
| `ghcr.io/aaronwald/ssmd-agent` | 0.1.5 | ~150MB |
