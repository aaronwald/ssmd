# Implementation Notes - 2025-12-26

## Session Overview

- **Date**: 2025-12-26
- **Primary Objectives**: Project catchup, documentation cleanup, agent streaming fixes, prompt externalization
- **Overall Outcome**: Successful documentation reorganization, agent REPL fixes, and prompt refactoring

---

## What Was Accomplished

### Documentation Reorganization
- [x] Updated DEPLOYMENT.md to remove ssmd-agent (it's a local dev tool, not deployed service)
- [x] Added ssmd-data deployment section to DEPLOYMENT.md
- [x] Created AGENT.md with local testing instructions
- [x] Moved 7 completed plans from `docs/plans/` to `docs/plans/completed/`
- [x] Moved `docs/plans/designs/` to `docs/designs/`
- [x] Consolidated top-level `designs/` into `docs/designs/`
- [x] Simplified README.md from 371 lines to 89 lines (high-level overview only)
- [x] Updated CLAUDE.md with all Makefile targets (data-*, agent-*)
- [x] Created `docs/reference/agent-tools.md` documenting all tools and state

### Makefile Updates
- [x] Updated `all-test` to include `data-test` and `agent-test`
- [x] Updated `all-lint` to include `agent-check`

### Agent Fixes and Enhancements
- [x] Fixed streaming output showing `[object Object]` - now extracts text from content blocks
- [x] Added token usage display after each response: `[tokens] in: X, out: Y`
- [x] Externalized system prompt to `prompts/system.md` with `{{skills}}` placeholder
- [x] Added `promptsPath` config (`SSMD_PROMPTS_PATH` env var)

### TODO Updates
- [x] Added "Next Up" section with immediate priorities
- [x] Added OpenRouter integration to Next Up
- [x] Added API key management UI with Authentik to Next Up
- [x] Added skills vs tools documentation task to Next Up
- [x] Added stream analysis skills (sequence numbers, gap detection, latency) to Next Up
- [x] Added complex workflows beyond ReactAgent to Future backlog

---

## Key Decisions Made

### ssmd-agent is a Local Dev Tool
- **Decision**: ssmd-agent runs on developer laptop, not deployed to Kubernetes
- **Rationale**: It's an interactive REPL for signal development, requires human interaction
- **Impact**: Removed from DEPLOYMENT.md, created separate AGENT.md

### Tools Stay in src/, Skills Stay Configurable
- **Decision**: Keep tools as TypeScript code in `src/agent/tools.ts`
- **Rationale**: Tools are executable code with dependencies, security risk if externalized
- **Trade-off**: Less flexible for users, but safer and type-checked
- **Future option**: Tool enablement config (which tools are active)

### Prompt Externalization
- **Decision**: Move system prompt to `prompts/system.md`
- **Rationale**: Allows customization without code changes
- **Pattern**: Uses `{{skills}}` placeholder, strips YAML frontmatter

---

## Files Created or Modified

### Created
| File | Description |
|------|-------------|
| `AGENT.md` | Local development guide for ssmd-agent |
| `ssmd-agent/prompts/system.md` | Externalized system prompt template |
| `docs/reference/agent-tools.md` | Comprehensive tools and state documentation |

### Modified
| File | Description |
|------|-------------|
| `DEPLOYMENT.md` | Removed ssmd-agent, added ssmd-data section |
| `README.md` | Simplified to high-level overview |
| `CLAUDE.md` | Added all Makefile targets |
| `Makefile` | Updated all-test, all-lint targets |
| `TODO.md` | Added Next Up section, new backlog items |
| `ssmd-agent/src/cli.ts` | Fixed streaming, added token usage |
| `ssmd-agent/src/agent/prompt.ts` | Load prompt from file |
| `ssmd-agent/src/agent/graph.ts` | Await async buildSystemPrompt |
| `ssmd-agent/src/config.ts` | Added promptsPath |

### Moved (git mv)
| From | To |
|------|-----|
| `docs/plans/2025-12-25-*.md` (6 files) | `docs/plans/completed/` |
| `docs/plans/designs/2025-12-23-agent-pipeline.md` | `docs/plans/completed/` |
| `docs/plans/designs/` | `docs/designs/` |
| `designs/` | `docs/designs/` |

---

## Commits Made

| SHA | Message |
|-----|---------|
| `2acccf8` | docs: clarify ssmd-agent is a local dev tool, add AGENT.md |
| `3b596bf` | docs: move completed plans to completed/ directory |
| `aa059d6` | docs: move designs to docs/designs |
| `ecd603c` | docs: consolidate designs/ into docs/designs/ |
| `213eec0` | docs: consolidate build commands and simplify README |
| `28e7c6c` | docs: add OpenRouter support to TODO |
| `5c7012c` | fix(agent): handle array content blocks in streaming output |
| `6540920` | feat(agent): display token usage after each response |
| `0bcaf5e` | docs: add Next Up section with immediate priorities |
| `19f9356` | docs: add stream analysis skills to TODO |
| `c480911` | refactor(agent): externalize system prompt to prompts/system.md |
| `e8d2812` | docs: add agent tools and state reference |
| `808b49e` | docs: add complex workflows to backlog |

---

## Issues Encountered and Resolved

### Streaming Output Showing [object Object]
- **Problem**: Agent REPL printed `[object Object]` instead of text
- **Root Cause**: LangChain/Anthropic streams content as array of blocks, not strings
- **Solution**: Extract text from content blocks in cli.ts streaming handler

### Git Commands Failing with Wrong Path
- **Problem**: `git add` failing with "pathspec did not match"
- **Root Cause**: Shell was in wrong directory after cd in previous command
- **Solution**: Use absolute paths with `cd /workspaces/ssmd &&` prefix

---

## Final Directory Structure

```
docs/
├── designs/                    # All design documents
│   ├── design_IV.md           # Current high-level design
│   ├── archive/               # Historical iterations (I-III)
│   ├── kalshi/                # Kalshi-specific designs (13 files)
│   ├── 2025-12-25-backtest-agent-skills.md
│   └── langchain-ideas.md
├── plans/                      # Implementation plans
│   ├── 2025-12-24-phase2-nats-streaming.md  # In progress
│   └── completed/              # 22 completed plans
└── reference/                  # CLI reference, file formats
    └── agent-tools.md          # NEW: Tools and state docs

ssmd-agent/
├── prompts/
│   └── system.md              # NEW: Externalized system prompt
├── skills/                    # Skill markdown files
└── src/
    └── agent/
        ├── prompt.ts          # UPDATED: Loads from file
        └── ...
```

---

## Next Steps

### Immediate (Next Up)
1. OpenRouter integration - alternative LLM provider
2. API key management UI with Authentik
3. Document skills vs tools design
4. Skills for stream analysis (sequence numbers, gap detection, latency)

### Backlog
- Complex workflows beyond ReactAgent (multi-step, state machines, human-in-the-loop)
- Memory persistence (PostgresSaver)
- Additional state builders (priceHistory, volumeProfile)

---

## Lessons Learned

### What Worked Well
- Separating deployment docs from local dev docs (DEPLOYMENT.md vs AGENT.md)
- Externalized prompts allow customization without code changes
- Comprehensive tools documentation helps clarify architecture

### What Could Be Improved
- Should have run agent with real API key earlier to catch streaming bug
- Consider adding integration test for streaming output format

### Tips for Future Sessions
- When refactoring, check all callers of modified functions (graph.ts needed await)
- Use `cd /workspaces/ssmd &&` prefix when git commands fail with path issues
- Test agent REPL with real API key after changes to streaming code
