direction: right

refdata: Reference Data {
  style.fill: "#e8f5e9"
  api: ssmd-data-ts
  postgres: PostgreSQL {
    shape: cylinder
  }
  redis: Redis {
    shape: cylinder
    style.fill: "#ffcdd2"
  }
  api -> postgres
  api -> redis: cache
}

capture: Data Capture {
  style.fill: "#fff3e0"
  nats: NATS JetStream {
    shape: cylinder
  }
  archiver: ssmd-archiver
  nats -> archiver
}

llm: LLM Providers {
  style.fill: "#fce4ec"
  anthropic: Anthropic API
  openrouter: OpenRouter Proxy {
    style.fill: "#f8bbd9"
  }
}

agent: Agent (ssmd-agent) {
  style.fill: "#f3e5f5"

  prompts: Prompts {
    shape: oval
  }
  repl: LangGraph REPL

  guardrails: Guardrails {
    style.fill: "#ffebee"
    example: |md
      - Input: message trimming
      - Output: toxicity, hallucination
      - Tool: trading approval
    |
  }

  tools: Tools {
    style.fill: "#e0f2f1"
    example: |md
      - list_events / list_markets
      - get_fee_schedule
      - run_backtest
      - get_today
    |
  }

  builders: State Builders {
    style.fill: "#fff8e1"
    example: |md
      - VolumeProfileBuilder
      - OrderbookBuilder
    |
  }

  prompts -> repl
  repl -> guardrails
  guardrails -> tools
  repl -> builders
}

signals: signals/*.ts {
  shape: document
  style.fill: "#f3e5f5"
}

usage: Usage Tracking {
  style.fill: "#e3f2fd"
  shape: cylinder
}

refdata.api -> agent.tools: HTTP API
capture.nats -> agent.builders: {style.stroke-dash: 3}
agent -> signals: generates
llm -> agent.repl: completions
agent.repl -> usage: track tokens
